<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>File: README</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html" title="Index">Index</a> &raquo; 
    <span class="title">File: README</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><div id='filecontents'><h1 id='utf8_utils'>UTF8 Utils</h1>

<p>This library provides a means of cleaning UTF8 strings with invalid characters.</p>

<p>It provides functionality that replaces <a href='http://api.rubyonrails.org/classes/ActiveSupport/Multibyte/Chars.html#M000977'>ActiveSupport&#8217;s <code>tidy_bytes</code> method</a>, with a faster algorithm that works on 1.8.6 - 1.9.x.</p>

<p>I&#8217;ve sent this code <a href='https://rails.lighthouseapp.com/projects/8994/tickets/4350-tidy_bytes-fails-on-19x'>as a patch to ActiveSupport</a>; in the mean time you can access at <a href='github.com/norman/utf8_utils'>its home on Github</a>.</p>

<h2 id='the_problem'>The Problem</h2>

<p>Your application may have to deal with invalid UTF-8 strings that come from user input that is copied and pasted from Microsoft Word, and includes Windows-encoded &#8220;smart quotes,&#8221; or other characters. This is only one scenario; there are many ways your application could receive such input.</p>

<p>Here&#8217;s what happens when you try to access a string with invalid UTF-8 characters in Ruby 1.9:</p>

<pre class="code"><span class='ruby identifier id'>ruby</span><span class='minus op'>-</span><span class='float val'>1.9</span><span class='integer val'>.1</span><span class='minus op'>-</span><span class='p378 identifier id'>p378</span> <span class='gt op'>&gt;</span> <span class='string val'>&quot;my messed up \x92 string&quot;</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='regexp val'>//</span><span class='u identifier id'>u</span><span class='rparen token'>)</span>
<span class='ArgumentError constant id'>ArgumentError</span><span class='colon op'>:</span> <span class='invalid identifier id'>invalid</span> <span class='byte identifier id'>byte</span> <span class='sequence identifier id'>sequence</span> <span class='in in kw'>in</span> <span class='UTF constant id'>UTF</span><span class='minus op'>-</span><span class='integer val'>8</span>
        <span class='from identifier id'>from</span> <span class='lparen token'>(</span><span class='irb identifier id'>irb</span><span class='rparen token'>)</span><span class='symbol val'>:3</span><span class='symbol val'>:in</span> <span class='xstring val'>`split'
        from (irb):3
        from /Users/norman/.rvm/rubies/ruby-1.9.1-p378/bin/irb:17:in `</span><span class='lt op'>&lt;</span><span class='main identifier id'>main</span><span class='gt op'>&gt;</span><span class='string val'>'
</span></pre>

<p>Ruby is quite particular about this - accessing the data in the string is difficult as almost all string access methods will die with this error.</p>

<h2 id='the_solution'>The Solution</h2>

<p>This library breaks the string down into an array of raw bytes, and cleans up the ones that are impossible UTF-8 sequences.</p>

<pre class="code"><span class='ruby identifier id'>ruby</span><span class='minus op'>-</span><span class='float val'>1.9</span><span class='integer val'>.1</span><span class='minus op'>-</span><span class='p378 identifier id'>p378</span> <span class='gt op'>&gt;</span> <span class='string val'>&quot;my messed up \x92 string&quot;</span><span class='dot token'>.</span><span class='tidy_bytes identifier id'>tidy_bytes</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='regexp val'>//</span><span class='u identifier id'>u</span><span class='rparen token'>)</span>
 <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='string val'>&quot;m&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;y&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;m&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;e&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;s&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;s&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;e&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;d&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;u&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;p&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;â€™&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;s&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;t&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;r&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;i&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;n&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;g&quot;</span><span class='rbrack token'>]</span>
</pre>

<p>Note that, like ActiveSupport, it naively assumes if you have invalid UTF8 characters, their encoding is either Windows CP1252 or ISO-8859-1. In practice this isn&#8217;t a bad assumption, but may not always work.</p>

<p>This library&#8217;s <code>tidy_bytes</code> method is a little less than twice as fast as the one provided by ActiveSupport:</p>

<pre class="code">                           <span class='bitor op'>|</span> <span class='ACTIVE_SUPPORT constant id'>ACTIVE_SUPPORT</span> <span class='bitor op'>|</span> <span class='UTF8_UTILS constant id'>UTF8_UTILS</span> <span class='bitor op'>|</span>
<span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
<span class='tidy identifier id'>tidy</span> <span class='bytes identifier id'>bytes</span>          <span class='x20000 identifier id'>x20000</span> <span class='bitor op'>|</span>          <span class='float val'>1.004</span> <span class='bitor op'>|</span>      <span class='integer val'>0</span><span class='integer val'>.607</span> <span class='bitor op'>|</span>
<span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='eqq op'>===</span><span class='assign token'>=</span>
<span class='Total constant id'>Total</span>                      <span class='bitor op'>|</span>          <span class='float val'>1.004</span> <span class='bitor op'>|</span>      <span class='integer val'>0</span><span class='integer val'>.607</span> <span class='bitor op'>|</span>
</pre>

<h2 id='getting_it'>Getting it</h2>

<pre class="code"><span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span> <span class='utf8_utils identifier id'>utf8_utils</span>
</pre>

<h2 id='using_it'>Using it</h2>

<pre class="code"><span class='comment val'># encoding: utf-8</span>
<span class='require identifier id'>require</span> <span class='string val'>&quot;utf8_utils&quot;</span>

<span class='comment val'># tidy bytes</span>
<span class='good_string identifier id'>good_string</span> <span class='assign token'>=</span> <span class='bad_string identifier id'>bad_string</span><span class='dot token'>.</span><span class='tidy_bytes identifier id'>tidy_bytes</span>

<span class='comment val'># tidy bytes in-place</span>
<span class='string identifier id'>string</span><span class='dot token'>.</span><span class='tidy_bytes! fid id'>tidy_bytes!</span>

<span class='comment val'># assume string is 100% ISO-8859-1 or CP-1251 and recode it to UTF-8</span>
<span class='good_string identifier id'>good_string</span> <span class='assign token'>=</span> <span class='bad_string identifier id'>bad_string</span><span class='dot token'>.</span><span class='tidy_bytes identifier id'>tidy_bytes</span><span class='lparen token'>(</span><span class='true true kw'>true</span><span class='rparen token'>)</span>
</pre>

<h2 id='api_docs'>API Docs</h2>

<p><a href='http://norman.github.com/utf8_utils'>http://norman.github.com/utf8_utils</a></p>

<h2 id='credits'>Credits</h2>

<p>Created by Norman Clarke.</p>

<p>Copyright (c) 2010, released under the MIT license.</p></div></div>
    
    <div id="footer">
  Generated on Fri Apr  9 09:49:54 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.5.4 (ruby-1.8.7).
</div>

  </body>
</html>